<!--
 * @Description: React学习
 * @Autor: Xdg
 * @Date: 2021-01-14 14:54:28
 * @LastEditors: Xdg
 * @LastEditTime: 2021-01-15 14:10:44
 * @FilePath: \Daily\React\Fiber.md
-->

# 1. 屏幕刷新率
- 60次/秒
- 浏览器渲染动画或页面的每一帧速率要和设备刷新率保持一致
- 每一帧的预算时间是16.66毫秒

# 2. 帧
- 每帧开头包括样式计算、布局和绘制
- JS执行JS引擎和页面渲染引擎在同一个渲染进程，GUI渲染和JS执行时互斥的
- 如果某个任务执行时间过长，浏览器会推迟渲染
## 2.1 请求帧动画rAF
- requestAnimationFrame回调函数会在绘制前执行
## 2.2 请求空闲回调rIC
- 希望快速响应用户，让用户觉得够快，不能阻塞用户的交互
- requestIdleCallback使开发者能够在主事件循环上执行后台和低优先级工作，而不影响延迟关键时间，如动画和输入响应
- 正常帧任务完成后没超过16ms，说明时间有富余，此时会执行rIC里注册的任务
  
# 3. 单链表
- 单链表是一种链式存取的数据结构
- 链表中的数据是以节点来表示的，每个节点的构成：元素（存储数据的单元）+指针（连接节点的地址：指示后继元素存储位置）
  
# 4. Fiber历史
## 4.1 Fiber之前的协调
- React会递归比对VDOM树，找出需要变动的节点，然后同步更新它们。这个过程React称为Reconciliation(协调)
- 在协调期间，React会一直占用浏览器资源，一则导致用户触发的事件得不到响应，二则会导致掉帧，感觉到卡顿
  
## 4.2 Fiber是什么
- 我们可以通过某些调度策略合理分配CPU资源，从而提高用户的响应速度
- 通过Fiber架构，让自己的协调过程可以被中断。适时地让出CPU执行权，可以让浏览器及时的响应用户的交互
  
### 4.2.1 Fiber是一个执行单元
- 每次执行完成一个执行单元，React就会检查现在还剩多少时间，如果没有时间就将控制权让出去

### 4.2.2 Fiber是一种数据结构
- React目前的做法是使用链表，每个VDOM节点内部表示为一个Fiber
  
```
  type Fiber = {
    // 类型
    type: any,
    // 父节点
    return: Fiber,
    // 第一个子节点
    child: Fiber,
    // 下一个兄弟
    sibling: Fiber,
  }
```

# 5. Fiber执行阶段
- 每次渲染都有两个阶段： Reconciliation(协调/render阶段)和Commit(提交阶段)
- 协调：可以认为是Diff阶段，可以被中断，这个阶段会找出所有节点变更，如节点新增、删除、属性变更等，这些变更React称之为副作用
- 提交：将上一个阶段计算出来需要处理的副作用（Effects）一次性执行了，这个阶段必须同步执行，不能被打断

## 5.1 render阶段
- render阶段会构建fiber树